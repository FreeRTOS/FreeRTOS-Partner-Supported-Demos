-------------------------------------------------------------------------------
-- File name: U2B_startup_PEn.850
-------------------------------------------------------------------------------
-- Environment:
--              Device:         U2B
--              IDE:            GHS Multi V7.1.4 or later
-------------------------------------------------------------------------------

-------------------------------------------------------------------------------
-------------  Selection of external interrupt service handler
-------------  User modifiable section
-------------  Please uncomment the required interrupt service handler
-------------------------------------------------------------------------------
#include <Startup.inc>

-------------------------------------------------------------------------------
-------------  Basic Initialisation of the controller
-------------  User modifiable section
-------------------------------------------------------------------------------
  .extern __unused_isr
  .extern _stacktop_PE1
  .extern _stacktop_PE2
  .extern _exit
  .set    CUx_EBV, 0x00018000
  .text

-------------------------------------------------------------------------------
-------------  PEn Specific Startup Routine
-------------------------------------------------------------------------------
  .global _RESET_PEn
_RESET_PEn:

  -- Initialization of the global pointer
  mov   __gp, gp
  -- Initialization of the text pointer
  mov   __tp, r5

  -- Then set 1 to PSW.EBV -> RBASE!=EBASE
  -- Then set 1 to PSW.CU0 and CU1
  stsr  PSW, r10, 0
  mov   CUx_EBV, r11
  or    r11, r10
  ldsr  r10, PSW, 0

#if defined (PE1_USED)
  jmpIfPEn  _INIT_PE1, PE1
#endif

#if defined (PE2_USED)
  jmpIfPEn  _INIT_PE2, PE2
#endif

_loop:
  br    _loop

-------------------------------------------------------------------------------
-------------  PE1 Specific Startup Routine
-------------------------------------------------------------------------------
#if defined (PE1_USED)
_INIT_PE1:

_STACKINIT_PE1:
  STACKSIZE  .set  0x1000
    .section ".stack1_PE1", bss
    .align 4
    .ds  (STACKSIZE)
    .align 4
  _stacktop_PE1:
  .previous

  -- Initialization of the stack pointer
  mov   ___ghsend_stack1_PE1, sp

  -- Initialization of the interrupt base pointer
  mov   _g_vector_table_PE1, r1
  ldsr  r1, INTBP, 1

  -- First set EBASE register address
  mov   ___ghsbegin_intvect_PE1, r10
  mov   0x0000003, r11 -- DV, RINT bit
  or    r11, r10
  ldsr  r10, 3, 1 -- EBASE
  SYNCI

  mov   CUx_EBV, r11 -- CUx_EBV
  or    r11, r10
  ldsr  r10, 5, 0 -- PSW
  SYNCI

  -- Jump to  main_PE1()
  jarl  _main_PE1, lp
  mov   r10, r6
  jarl  _exit, lp
#endif

-------------------------------------------------------------------------------
-------------  PE2 Specific Startup Routine
-------------------------------------------------------------------------------
#if defined (PE2_USED)
_INIT_PE2:

_STACKINIT_PE2:
  STACKSIZE  .set  0x1000
    .section ".stack2_PE2", bss
    .align 4
    .ds  (STACKSIZE)
    .align 4
  _stacktop_PE2:
  .previous

  -- Initialization of the stack pointer
  mov   ___ghsend_stack2_PE2, sp

  -- Initialization of the interrupt base pointer
  mov   _g_vector_table_PE2, r1
  ldsr  r1, INTBP, 1

  -- First set EBASE register address
  mov   ___ghsbegin_intvect_PE2, r10
  mov   0x0000003, r11 -- DV, RINT bit
  or    r11, r10
  ldsr  r10, 3, 1 -- EBASE
  SYNCI

  mov   CUx_EBV, r11 -- CUx_EBV
  or    r11, r10
  ldsr  r10, 5, 0 -- PSW
  SYNCI

  -- Jump to  main_PE2()
  jarl  _main_PE2, lp
  mov   r10, r6
  jarl  _exit, lp
#endif

-------------------------------------------------------------------------------
-------------  Start Section for exception table
#if defined (PE1_USED)
.section".intvect_PE1",.text
-------------------------------------------------------------------------------
__ex_entry_PE1:
----RESET
    .offset 0x0000
    .extern _RESET
    jr _RESET

----SYSERR
    .offset 0x0010
    jr __unused_isr

----FETRAP
    .offset 0x0030
    jr __unused_isr

----TRAP0
    .offset 0x0040
    .extern _vTRAP0_Handler
    jr _vTRAP0_Handler

----TRAP1
    .offset 0x0050
    jr __unused_isr

----RIEX
    .offset 0x0060
    jr __unused_isr

----UCPOP
    .offset 0x0080
    jr __unused_isr

----MIP_MDP
    .offset 0x0090
    jr __unused_isr

----PIE
    .offset 0x00a0
    jr __unused_isr

----MAE_MAEX
    .offset 0x00c0
    jr __unused_isr

----FENMI
    .offset 0x00e0
    jr __unused_isr

----FEINT
    .offset 0x00f0
    jr __unused_isr

----EIINTn priority_0
    .offset 0x0100
    .extern _vIrq_Handler
    jr _vIrq_Handler

#endif
-------------  End of exception table
-------------------------------------------------------------------------------

-------------------------------------------------------------------------------
-------------  Start Section for exception table
#if defined (PE2_USED)
.section".intvect_PE2",.text
-------------------------------------------------------------------------------
__ex_entry_PE2:
----RESET
    .offset 0x0000
    .extern _RESET
    jr _RESET

----SYSERR
    .offset 0x0010
    jr __unused_isr

----FETRAP
    .offset 0x0030
    jr __unused_isr

----TRAP0
    .offset 0x0040
    .extern _vTRAP0_Handler
    jr _vTRAP0_Handler

----TRAP1
    .offset 0x0050
    jr __unused_isr

----RIEX
    .offset 0x0060
    jr __unused_isr

----UCPOP
    .offset 0x0080
    jr __unused_isr

----MIP_MDP
    .offset 0x0090
    jr __unused_isr

----PIE
    .offset 0x00a0
    jr __unused_isr

----MAE_MAEX
    .offset 0x00c0
    jr __unused_isr

----FENMI
    .offset 0x00e0
    jr __unused_isr

----FEINT
    .offset 0x00f0
    jr __unused_isr

----EIINTn priority_0
    .offset 0x0100
    .extern _vIrq_Handler
    jr _vIrq_Handler

#endif
-------------  End of exception table
